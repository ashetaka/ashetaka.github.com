### 1.配置nginx 服务器
1.配置vhost

vim /usr/local/sinasrv2/conf/vhost/de.weibo.com.conf 



    server {                                                                                                                                            
        listen       80 ;
        root /data1/www/htdocs/we.weibo.com/application/public;
        server_name  we.weibo.com;
        access_log  /data1/www/logs/we.weibo.com-access_log  main;
        error_log   /data1/www/logs/we.weibo.com-error_log;
        try_files $uri $uri/index.php;
        gzip on;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_types text/plain text/css application/xml application/x-javascript;
        gzip_vary on;

        location /data/ { alias /data1/www/data/we.weibo.com/; }
        location /cache/ { alias /data1/www/cache/we.weibo.com/; }

            if (!-e $request_filename) {
              rewrite "^/(.*)$" /index.php/$1 break;
            }   

        location  / { 

            fastcgi_pass 0.0.0.0:9000;
            fastcgi_split_path_info ^(.+.php)(.*)$;
            fastcgi_index index.php;
            include fastcgi_params;

            fastcgi_param SINASRV_DATA_DIR "/data1/www/data/we.weibo.com/";
            fastcgi_param SINASRV_APPLOGS_DIR "/data1/www/applogs/we.weibo.com/";
            fastcgi_param SINASRV_DATA_URL "http://we.weibo.com/data";
            fastcgi_param SINASRV_CACHE_URL "http://we.weibo.com/cache";


            fastcgi_param SINASRV_DB_HOST 10.210.230.31;
            fastcgi_param SINASRV_DB_HOST_R 10.210.230.31;
            fastcgi_param SINASRV_DB_PORT 3306;
                fastcgi_param SINASRV_DB_NAME weibo_evaluate;
                fastcgi_param SINASRV_DB_USER searchqa;
                fastcgi_param SINASRV_DB_PASS searchqa;
                fastcgi_param SINASRV_DB_PORT_R 3306;
                fastcgi_param SINASRV_DB_NAME_R weibo_evaluate;
                fastcgi_param SINASRV_DB_USER_R searchqa;
                fastcgi_param SINASRV_DB_PASS_R searchqa;
            }
    }      
    
2.重启 nginx

	/usr/local/sinasrv2/sbin/nginx -s reload
### 2.yaf 代码环境搭建
目录结构

    |-- application
    |   |-- Bootstrap.php
    |   |-- conf
    |   |   `-- Yaf_Application.ini
    |   |-- controllers
    |   |-- library
    |   |-- public
    |   |   |-- css
    |   |   |-- fonts
    |   |   |-- img
    |   |   |-- index.php
    |   |   |-- js
    |   `-- views
    |-- config
    |   `-- env.ini
    
#### 入口文件
入口文件为所有请求的入口，所有请求均会被重定向到这个文件。为实现重定向，需为服务器重写路由规则

	nginx.conf
        if (!-e $request_filename) {
          rewrite "^/(.*)$" /index.php/$1 break;
        }  

入口文件定义如下

    <?php
    define('ROOT_PATH', dirname(dirname(dirname(__FILE__))));

    define('APP_PATH', ROOT_PATH.'/application');
    define('TPL_PATH', APP_PATH.'/views');                                                                                                              
    define('CONF_PATH', APP_PATH.'/conf');
    define('CONFIG_PATH', ROOT_PATH.'/config');
    define('LIBRARY_PATH', APP_PATH.'/library');

    ini_set('yaf.library', LIBRARY_PATH);

    error_reporting(E_ALL & ~E_NOTICE);
    $app = new Yaf_Application(APP_PATH . '/conf/Yaf_Application.ini');
    $app->bootstrap()->run();

#### 资源文件
将需要引用的资源文件放在 application/public的对应目录下，如 jquery-latest.js 放入 js 中

#### 引导程序
引导程序用于做全局自定义工作。如读取数据库读写配置、日志模块加载等。

#### 补充
其余目录用途：

- controllers：控制器

- library：自定义类放置目录

- views：视图目录

### 3.数据库配置

在 env.ini 中添加数据库读写配置

    Yal_Db_Pool.PdoMysql.evaluate.write.host = "10.210.230.31"
    Yal_Db_Pool.PdoMysql.evaluate.write.port = "3306"
    Yal_Db_Pool.PdoMysql.evaluate.write.name = "weibo_evaluate"
    Yal_Db_Pool.PdoMysql.evaluate.write.user = "searchqa"
    Yal_Db_Pool.PdoMysql.evaluate.write.pass = "searchqa"
    Yal_Db_Pool.PdoMysql.evaluate.write.attr.1002 = "SET NAMES utf8"
     
    Yal_Db_Pool.PdoMysql.evaluate.read.host = "10.210.230.31"
    Yal_Db_Pool.PdoMysql.evaluate.read.port = "3306"
    Yal_Db_Pool.PdoMysql.evaluate.read.name = "weibo_evaluate"
    Yal_Db_Pool.PdoMysql.evaluate.read.user = "searchqa"
    Yal_Db_Pool.PdoMysql.evaluate.read.pass = "searchqa"
    Yal_Db_Pool.PdoMysql.evaluate.read.attr.1002 = "SET NAMES utf8"

### 4.上传 svn
	cd we.weibo.com

	svn import . https://svn1.intra.sina.com.cn/weibo_QA/TEST/Projects/searchqa/branch -m "initial import"

### 5.测试
用以下文件测试

    <?php
    class TestController extends Yaf_Controller_Abstract{
        public function indexAction(){
            echo 'works';
            $da = new DA_Dbtest();                                                                                                                      
        	$da->run();
        }   
    }
    ?>

然后绑定 hosts：

	10.210.230.31 we.weibo.com

访问http://we.weibo.com/test 显示『works』以及数据库查询结果，说明已配置完毕。


	