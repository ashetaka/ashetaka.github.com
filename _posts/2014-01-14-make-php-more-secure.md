---
layout: post
title: "让PHP代码更安全"
description: ""
category: "learning"
tags: [php]
---
{% include JB/setup %}

最近看了Dave Child的"Writing Secure PHP"系列，虽然文章年代久远，不过大部分内容依旧适用，收益匪浅。下面就对此自己做个总结，也算是重新过一遍。

### 引言

PHP容易上手，这点无可争议。同时带来的问题是，php程序员，尤其是新手，很可能对自己代码的安全性一无所知。他们很难发现自己代码中潜在的危险，因为他们根本没意识到这一点。以下就是一些常见的问题以及对应的避免方法或是解决方案。

### 首要法则：永远不要相信你的用户

Dave觉得这个法则说再多次也不为过。为什么呢？几种常见的错误想法是：

1. 没人知道我的网站
2. 即便有人知道，黑客们也不屑动手
3. 我的网站即使被攻破也不会有重大损失

不谈上述想法究竟是否有道理，很重要的一点是，你的网站出现了漏洞，往往不是因为有人恶意攻击，而是普通用户的不当操作无意为之的结果。

所以，千万别信任用户。每一份经用户提交到服务器的数据都有可能危害你的网站。这是web开发人员要注意的首要法则。

### 关掉错误信息

错误信息对开发人员来说是很有用的--在开发环境下。如果是在生产环境下呢？相比错误信息直接输出到网页上带来的用户体验下降，你更需要关注的是这些错误信息对黑客来说也是很有用的。所以在你的生产环境里，记得把"error_reporting"设为0.然后再你的开发环境里，设一个不同的错误级别。

### SQL注入

SQL注入的危害不言而喻，如果你还不了解的话，建议找相关的资料仔细看看。这里只做简单介绍。

比如你的网站有登陆的功能，当你要检查用户登陆信息是否正确的时候，可能会用这样的语句：

{% highlight php startinline linenos  %}
$sql = "select * from users where username='" . $_POST['user'] . "'";
$userinfo = mysql_query($sql);
{% endhighlight %} 

相信很多人都写过类似的代码，功能上没有问题。但是安全上呢？假如给$_POST['user']加上`' OR 1=1 #`会发生什么呢。

$sql就变成了

select * from users where username='' OR 1=1 #'

\#号后面的内容会被忽略。很显然，由于1=1是成立的，所以这句话会选出users表中所有的行。这并不是你想要的结果，你想要的只是当前用户的信息。假如此时，你又正好把数据库查询的结果给输出到页面上了，后果自然不堪设想。

不过事情也没这么糟糕，要避免这一点只需要使用mysql_real_escape_string()函数来为每一个输入做转义即可。

如

{% highlight php startinline linenos  %}
$name = mysql_real_escape_string($_POST['user']);
$sql = "select * from users where username='" . $name . "'";
$userinfo = mysql_query($sql);
{% endhighlight %} 

### 文件操作

有的站点可能会用这样的链接

	index.php?page=contactus.html

文件index.php包含了contactus.html文件。这是能起作用的。但是用户可以把contactus.html修改成别的他们想要的东西。假如你的目录下有一个文件"A"，里面存储了一些密码信息。此时只要用户用page=A就能轻而易举地访问到A文件的内容。

不过所幸，这也很容易防范。在php.ini中正确设置open_basedir，然后把allow_url_fopen设为off。这样就可以阻止大部分此类非法访问。

### 使用默认账号

mysql安装以后，会有一个默认账户root，而且初始密码是空的，如果你没设的话。如果有人得到了你的数据库地址，这些默认账号都是他尝试的选择。所以如果你还是使用的默认设置，请尽快修改账号密码。

### 保留安装文件在线上

许多安装文件在被用来安装程序后就不再被理会了。若是这部分程序被他们发现，对他们来说都是可用的，他们就能重装这部分程序来覆盖现在的版本。

### 可预测的东西

假如有人要进入你的站点后台，也许他们会尝试www.aaa.com/admin这种格式的地址。如果正巧被他们猜对了，那么你的站点就有危险了。所以你的后台地址尽量用不规则的名字，类似admin、administartor这样的常见地址都是不安全的。

对于用户名和密码也一样，一定不能用可以被猜到的常见数字或单词。

另外记得不要让出错信息暴露太多东西。比如登陆时显示“密码错误”，那么就会让入侵者明白现在用户名对了；或是显示“用户名”错误，这就是提示他们现在用户名还不对。只要直接提示“登录错误”就行了。